var ge=Object.create;var k=Object.defineProperty,fe=Object.defineProperties,pe=Object.getOwnPropertyDescriptor,be=Object.getOwnPropertyDescriptors,ve=Object.getOwnPropertyNames,Q=Object.getOwnPropertySymbols,ye=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty,we=Object.prototype.propertyIsEnumerable;var B=(r,e,t)=>e in r?k(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,E=(r,e)=>{for(var t in e||(e={}))X.call(e,t)&&B(r,t,e[t]);if(Q)for(var t of Q(e))we.call(e,t)&&B(r,t,e[t]);return r},Z=(r,e)=>fe(r,be(e)),xe=r=>k(r,"__esModule",{value:!0});var Pe=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var _e=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ve(e))!X.call(r,s)&&s!=="default"&&k(r,s,{get:()=>e[s],enumerable:!(t=pe(e,s))||t.enumerable});return r},v=r=>_e(xe(k(r!=null?ge(ye(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var d=(r,e,t)=>(B(r,typeof e!="symbol"?e+"":e,t),t);var ae=Pe(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});var L=function(r,e){return L=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(t[o]=s[o])},L(r,e)};function Y(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function t(){this.constructor=r}L(r,e),r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var F,K=function(){function r(){}return r._xfnv1a=function(e){for(var t=2166136261,s=0;s<e.length;s++)t=Math.imul(t^e.charCodeAt(s),16777619);return function(){return t+=t<<13,t^=t>>>7,t+=t<<3,t^=t>>>17,(t+=t<<5)>>>0}},r}(),Oe=function(r){function e(t){var s=r.call(this)||this;return s.a=e._xfnv1a(t)(),s}return Y(e,r),e.prototype.next=function(){var t=this.a+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296},e}(K),Se=function(r){function e(t){var s=r.call(this)||this,o=e._xfnv1a(t);return s.a=o(),s.b=o(),s.c=o(),s.d=o(),s}return Y(e,r),e.prototype.next=function(){this.a>>>=0,this.b>>>=0,this.c>>>=0,this.d>>>=0;var t=this.a+this.b|0;return this.a=this.b^this.b>>>9,this.b=this.c+(this.c<<3)|0,this.c=this.c<<21|this.c>>>11,this.d=this.d+1|0,t=t+this.d|0,this.c=this.c+t|0,(t>>>0)/4294967296},e}(K),Ge=function(r){function e(t){var s=r.call(this)||this,o=e._xfnv1a(t);return s.a=o(),s.b=o(),s.c=o(),s.d=o(),s}return Y(e,r),e.prototype.next=function(){var t=this.b<<9,s=5*this.a;return s=s<<7|9*(s>>>25),this.c^=this.a,this.d^=this.b,this.b^=this.c,this.a^=this.d,this.c^=t,this.d=this.d<<11|this.d>>>21,(s>>>0)/4294967296},e}(K);R.PRNG=void 0,(F=R.PRNG||(R.PRNG={})).sfc32="sfc32",F.mulberry32="mulberry32",F.xoshiro128ss="xoshiro128ss";var ke=function(){function r(e,t){t===void 0&&(t=R.PRNG.sfc32),this.str=e,this.prng=t,this.generator=this._initializeGenerator()}return r.prototype.next=function(){return this.generator.next()},r.prototype._initializeGenerator=function(){if(function(t){return t===null}(e=this.str)||function(t){return t===void 0}(e))return this.wrap();var e;switch(this.prng){case"sfc32":return new Se(this.str);case"mulberry32":return new Oe(this.str);case"xoshiro128ss":return new Ge(this.str);default:return this.wrap()}},r.prototype.wrap=function(){return{next:function(){return Math.random()}}},r}();R.default=ke});var le=v(require("path")),ue=v(require("fs"));var J=v(require("path")),V=[{flag:"-d",desc:"Indica que as sa\xEDdas de debug devem ser impressas.",process:r=>r.debug=!0,num:0},{flag:"-q",desc:'Entra no modo "quiet": roda todo o jogo e s\xF3 imprime o resultado final (sobrescreve o par\xE2metro de debug).',process:r=>{r.quiet=!0,r.debug=!1},num:0},{flag:"-i",desc:"Entra no modo iterativo. A cada rodada, o jogo espera o usu\xE1rio digitar <enter> para continuar.",process:r=>r.interactive=!0,num:0},{flag:"-m",desc:"Salva as mensagens enviadas para os bots, \xFAtil para debugar. Cada bot ter\xE1 seu arquivo com a extens\xE3o .in",process:r=>r.messages=!0,num:0},{flag:"-r",desc:"L\xEA o estado do jogo especificado em um arquivo, sobrescrevendo argumentos passados. Exemplo: -r game.state",process:(r,e,t)=>r.readfile=e[t+1],num:1},{flag:"-s",desc:"Indica uma semente para o gerador de n\xFAmero aleat\xF3rios. A semente deve ser um valor inteiro. Exemplo: -s 24652",process:(r,e,t)=>r.seed=parseInt(e[t+1]),num:1},{flag:"-t",desc:"Indica o tempo (em milisegundos) que um bot tem para responder com uma a\xE7\xE3o antes de dar timeout (default: 3000). Exemplo: -t 2000",process:(r,e,t)=>r.timeout=parseInt(e[t+1]),num:1}];function Re(r,e=[]){let t=J.basename(process.argv[0]),s=J.basename(process.argv[1]);r.split(`
`).forEach(o=>console.log(o.trim())),console.log(`Uso: ${t} ${s} [op\xE7\xF5es] [bot1 bot2 ...]
`),console.log("As op\xE7\xF5es s\xE3o:"),V.concat(e).forEach(o=>console.log(o.flag,o.desc)),console.log(`
`)}function ee(r="",e=[]){let t=process.argv,s={debug:!1,quiet:!1,interactive:!1,messages:!1,timeout:3e3};return V.concat(e).forEach(o=>{let u=t.indexOf(o.flag);u>1&&u<t.length-o.num&&(o.process(s,t,u),t.splice(u,o.num+1))}),t.includes("-h")&&(Re(r,e),process.exit(0)),s.bots=t.slice(2).filter(o=>!o.startsWith("-")),s}var D=v(require("path")),se=v(require("fs")),U=v(require("child_process"));var $e=v(require("child_process")),Ae=v(require("stream")),te=v(require("readline"));function re(r){let e=(0,te.createInterface)({input:r}),t=async function*(){for await(let s of e)yield s}();return async()=>(await t.next()).value}var l=r=>`[${r}m`,I={bold:l("1"),black:l("30"),red:l("31"),green:l("32"),yellow:l("33"),blue:l("34"),magenta:l("35"),cyan:l("36"),white:l("37"),gray:l("90"),bgBlack:l("40"),bgRed:l("41"),bgGreen:l("42"),bgYellow:l("43"),bgBlue:l("44"),bgMagenta:l("45"),bgCyan:l("46"),bgWhite:l("47"),bgGray:l("100"),reset:l("0")};function Ee(r){return r.endsWith(I.reset)?r:`${r}${I.reset}`}var a=Object.keys(I).reduce((r,e)=>Z(E({},r),{[e]:t=>Ee(`${I[e]}${t}`)}),{});var x=console.log,oe=a.bgGreen(a.black("DEBUG:")),T=class{constructor(e,t,s){this.game=e;this.id=t;this.execName=s;d(this,"_proc");d(this,"_read");d(this,"_errorPromise");d(this,"_msgStream",null);d(this,"_active");D.dirname(s)==="."?this._proc=(0,U.spawn)(D.join(process.cwd(),s)):this._proc=(0,U.spawn)(s),this.game.config.messages&&(this._msgStream=(0,se.createWriteStream)(s+".in")),this.game.config.quiet&&(x=()=>{}),this._proc.on("error",o=>{x(a.red(`Erro na execu\xE7\xE3o do programa ${s}.`)),x(a.red(o)),this.game.quit(t)}),this._proc.stderr.on("data",o=>{if(this.game.config.quiet===!1){let u=o.toString().replace(/\n/g,`
	`);x(a.red(`Bot ${t}:`)),x(a.red(`	${u}`))}}),this._errorPromise=new Promise(o=>{this._proc.on("close",(u,c)=>{c!=="SIGINT"?(x(a.red(`Programa ${this.execName} terminou com signal ${c}.`)),o("EXEC_ERROR")):o("FINISHED")})}),this._read=re(this._proc.stdout),this._active=!0}async write(e){if(this._active){this.game.config.debug&&console.debug(`${oe} Enviando para ${this.id}: ${e}`);let t=`${e}
`;this._msgStream&&this._msgStream.write(t);try{return this._proc.stdin.write(t),Promise.resolve("OK")}catch(s){return Promise.resolve("ERROR")}}}async read(){if(this._active){let e,t=new Promise(c=>{e=setTimeout(()=>c("TIMEOUT"),this.game.config.timeout)}),s=this._read(),o=this._errorPromise,u=await Promise.race([t,s,o]).then(c=>c===void 0||c==="EXEC_ERROR"?"ERROR":c);return u==="TIMEOUT"?(x(`Jogador ${this.id} n\xE3o enviou dados no tempo de ${this.game.config.timeout}ms e foi eliminado.`),Promise.resolve("PLAYER_ERROR")):u==="ERROR"?(x(`Jogador ${this.id} teve problemas t\xE9cnicos e foi eliminado.`),Promise.resolve("PLAYER_ERROR")):(clearTimeout(e),this.game.config.debug&&console.debug(`${oe} Recebido de ${this.id}: ${u}`),Promise.resolve(u))}}halt(){console.log(a.red(`Terminando o processo do jogador ${this.id}...`)),this._msgStream&&this._msgStream.close(),this._proc.kill("SIGINT"),this._active=!1}get isActive(){return this._active}};var ie=v(ae()),z,ne;function ce(r,e,t=0){return Math.floor(r*(e-t)+t)}function O(r){return typeof r=="number"&&(z=new ie.default(r.toString()),ne=r),ne}function $(){return z||O(ce(Math.random(),1e5)),z.next()}function S(r,e=0){return ce($(),r,e)}var h=class{constructor(e,...t){this.content=e;d(this,"params");this.params=t.map(s=>s.toString())}toString(){let e=this.params.join(" "),t=this.content.length>0&&e.length>0;return this.content+(t?" ":"")+e}static parse(e){let[t,...s]=e.split(" ").filter(o=>o.length>0);return new h(t,...s)}};var y;(function(s){s[s.FORWARD=0]="FORWARD",s[s.BACKWARD=1]="BACKWARD",s[s.RANDOM=2]="RANDOM"})(y||(y={}));var M=console.log,Ie=[a.cyan,a.yellow,a.magenta,a.cyan],j=class{constructor(e){this.config=e;d(this,"players");d(this,"currPlayerIndex");d(this,"flow");let t=ee(this.config.description,this.config.params);this.config=E(E({},e),t),this.config.quiet&&(M=()=>{}),this.config.readfile&&this.loadFile(this.config.readfile),this.config.seed||($(),this.config.seed=O()),M(`Seed da partida ${O()}`),(!this.currPlayerIndex||this.currPlayerIndex<0||this.currPlayerIndex>this.config.bots.length-1)&&(this.currPlayerIndex=S(this.config.bots.length)),this.players=this.config.bots.map(s=>new T(this,le.basename(s),s)),this.players.forEach((s,o)=>s.color=Ie[o]),this.flow=0}nextPlayer(){let e=this.players.length;switch(this.flow){case 0:this.currPlayerIndex=(this.currPlayerIndex+1)%e;break;case 1:this.currPlayerIndex=(this.currPlayerIndex+e-1)%e;break;case 2:this.currPlayerIndex=$()%e;break}}async run(){try{for(await this.config.init(),await this.config.start();;){await this.config.turn();do this.nextPlayer();while(!this.currentPlayer.isActive)}}catch(e){console.error(e),this.players.forEach(t=>t.halt())}}over(e){M(e),this.config.finish(),this.closeGame()}quit(e){this.players.find(s=>s.id===e).halt()}closeGame(){console.log(a.red("Encerrando o jogo...")),this.players.forEach(e=>e.halt()),process.exit()}loadFile(e){try{let t=ue.readFileSync(e,"utf8"),[s,o]=t.split(`---
`),u=s.match(/seed\s*:\s*(\d+)\s*\n/);u&&(this.config.seed=parseInt(u[1]));let c=s.match(/bots\s*:\s*([ \w]+)\n/);c&&(this.config.bots=c[1].split(" ").filter(_=>_&&_.length>0));let f=s.match(/curr\s*:\s*(\d+)\n/);f&&(this.currPlayerIndex=parseInt(f[1])),this.config.loadState(o)}catch(t){console.error(t)}}async forEachPlayer(e){await Promise.all(this.players.map(async t=>{await e(t)}))}get numPlayers(){return this.players.length}async send(e,t){let s=this.players.find(o=>o.id===e);if(s){let o=await s.write(t.toString());return o!=="OK"?(this.failPlayer("CONFIG ERROR",`Algo estranho ocorreu com o jogador ${s.id}`,s),"ERROR"):o}return"PLAYER ID not found."}async broadcast(e,t=this.players){await Promise.all(t.map(async s=>{await this.send(s.id,e)}))}async broadcastNonCurrent(e){await this.broadcast(e,this.players.filter(t=>t!=this.currentPlayer))}async receiveMessage(){let e=await this.currentPlayer.read();return h.parse(e)}failPlayer(e,t,s){M(`${s.id}: ${a.red(e)} ${t}`)}get currentPlayer(){return this.players[this.currPlayerIndex]}};var p="\u2665\u2666\u2663\u2660".split(""),C;(function(o){o[o.Heart=0]="Heart",o[o.Diamonds=1]="Diamonds",o[o.Clubs=2]="Clubs",o[o.Spades=3]="Spades"})(C||(C={}));var G=["2","3","4","5","6","7","8","9","10","V","D","R","A","C"],m;(function(i){i[i.Two=0]="Two",i[i.Three=1]="Three",i[i.Four=2]="Four",i[i.Five=3]="Five",i[i.Six=4]="Six",i[i.Seven=5]="Seven",i[i.Eight=6]="Eight",i[i.Nine=7]="Nine",i[i.Ten=8]="Ten",i[i.Jack=9]="Jack",i[i.Queen=10]="Queen",i[i.King=11]="King",i[i.Ace=12]="Ace",i[i.Joker=13]="Joker"})(m||(m={}));var g=class{constructor(e,t){d(this,"_value");d(this,"_suit");if(typeof e=="string"){let s=p.reduce((c,f)=>e.indexOf(f)>c?e.indexOf(f):c,-1);if(s<0||s>=p.length)throw new Error(`Carta ${e} \xE9 inv\xE1lida: n\xE3o h\xE1 naipe.`);let o=e.substring(0,s),u=e.substring(s);if(this._value=g.toValue(o),this._suit=g.toSuit(u),this._value<0||this._value>=G.length)throw new Error(`Carta ${e} \xE9 inv\xE1lida: valor inexistente.`)}else{if(t===void 0)throw new Error("Carta sem naipe associado.");this._value=e,this._suit=t}}static toSuit(e){let t=p.findIndex(s=>s===e);if(t<0)throw new Error("Naipe inv\xE1lido");return t}static toValue(e){let t=G.findIndex(s=>s===e);if(t<0)throw new Error("Valor da carta inv\xE1lido");return t}get value(){return this._value}get suit(){return this._suit}get str(){return G[this._value]+p[this._suit]}toString(){let e=a.black(G[this._value]),t=this._suit<2?a.red(p[this._suit]):a.black(p[this._suit]);return a.bgWhite(e)+a.bgWhite(t)}};function de(){let r=new q;for(let e=0;e<p.length;e++)for(let t=0;t<G.length-1;t++)r.push(new g(t,e));return r.push(new g(13,2)),r.push(new g(13,0)),r.shuffle(),r.shuffle(),r}var q=class{constructor(e=[]){this.cards=e}get length(){return this.cards.length}shuffle(){for(let e=this.cards.length-1;e>0;e--){let t=Math.floor($()*(e+1));[this.cards[e],this.cards[t]]=[this.cards[t],this.cards[e]]}}sort(){this.cards.sort((e,t)=>e.suit!=t.suit?e.suit-t.suit:e.value-t.value)}sorted(){let e=this.cards.slice();return e.sort((t,s)=>t.suit!=s.suit?t.suit-s.suit:t.value-s.value),e}get str(){return`[ ${this.cards.map(e=>e.str).join(" ")} ]`}toString(){return`[ ${this.cards.join(" ")} ]`}get top(){return this.cards[this.cards.length-1]}pop(){return this.cards.pop()}push(e){e!==void 0&&this.cards.push(e)}pushCards(e){e.forEach(t=>this.cards.push(t))}indexOf(e){return this.cards.findIndex(t=>t.value===e.value&&t.suit===e.suit)}has(e){return this.indexOf(e)>=0}hasAll(e){return e.every(t=>this.has(t))}remove(e){let t=this.indexOf(e);return t<0?!1:(this.cards.splice(t,1),!0)}removeCards(e){e.forEach(t=>this.remove(t))}clear(){this.cards=[]}merge(e){for(;e.length>0;)this.push(e.pop());return this.shuffle(),this}};var A=class{constructor(e){this.id=e;d(this,"_cards");A._bots.set(e,this),this._cards=new q}static get ids(){return[...A._bots.keys()]}static get bots(){return[...A._bots.values()]}static bot(e){return A._bots.get(e)}get cards(){return this._cards}checkDiscard(e,t){return this._cards.has(e)&&(e.value===m.Joker||e.value===m.Ace||e.suit===t)}validate(e){let t=e.content;try{let s=new g(t);return this._cards.has(s)?(this._cards.remove(s),new h(`DISCARD ${s.str}`)):new h(`ERROR A carta ${s.toString} n\xE3o se encontra na m\xE3o do jogador.`)}catch(s){return new h(`ERROR ${s}`)}}toString(){return`bot ${a.blue(this.id)}`}},P=A;d(P,"_bots",new Map);var H=7,De=[{flag:"-c",desc:"Define o n\xFAmero de cartas que cada jogador receber\xE1 no in\xEDcio do jogo.",process:(r,e,t)=>{H=parseInt(e[t+1]),console.log("N\xFAmero de cartas iniciais: ",H)},num:1}],Me=`=== UNO ===
Esta \xE9 uma vers\xE3o do jogo de baralho Uno, jogado com as cartas do baralho tradicional.
`,je=["DISCARD","BUY"],n=new j({description:Me,loadState:Ce,init:qe,start:Ne,turn:We,finish:Be,params:De});n.run();function Ce(r){}var N,w,W,b;async function qe(){n.numPlayers<2&&(console.log("O n\xFAmero de bot-jogadores \xE9 insuficiente. \xC9 preciso pelo menos 2 bots."),n.closeGame()),N=de(),w=new g(m.Ace,S(p.length)),W=w.suit,b=0,n.forEachPlayer(r=>{let e=new P(r.id);for(let t=0;t<H;t++)e.cards.push(N.pop())})}async function Ne(){let r=P.bots.map(e=>e.id).join(" ");await n.broadcast(new h("PLAYERS",r));for(let e of P.bots)await n.send(e.id,new h("YOU",e.id)),await n.send(e.id,new h("HAND",e.cards.str)),console.log(`O ${e} recebeu as cartas ${e.cards}`);await n.broadcast(new h("TABLE",w.str)),console.log(`Carta sobre a mesa: ${w}`)}function me(r){return r.value===m.Joker||r.value===m.Ace}async function We(){try{let r=n.currentPlayer.id,e=P.bot(r);await n.broadcast(new h(`TURN ${r}`));let t;do t=await n.receiveMessage(),t.content==="SAY"&&console.log(`O ${e} diz "${t.params.join(" ")}"`);while(!je.includes(t.content));switch(await n.broadcastNonCurrent(t),t.content){case"DISCARD":if(b>0){console.log(`O ${e} deveria comprar ${b} cartas, mas tentou descartar uma.`),console.log(`N\xE3o d\xE1 mais para sincronizar as a\xE7\xF5es e ${e} \xE9 eliminado.`),n.quit(r),b=0;break}let s=new g(t.params[0]);if(!e.cards.has(s)){console.log(`O ${e} tentou descartar a carta ${s}.`),console.log("Por\xE9m, o bot n\xE3o a possui na m\xE3o e a jogada foi invalidada.");break}let o=s.value===w.value,u=s.suit===W;if(!o&&!u&&!me(s)){console.log(`O ${e} tentou descartar a carta ${s}.`),console.log("Por\xE9m, nem o valor nem o naipe s\xE3o v\xE1lidos e a jogada foi invalidada.");break}if(console.log(`O ${e} descartou a carta ${s}.`),e.cards.remove(s),e.cards.length==0&&n.over(`O ${e} ganhou!!!`),w=s,W=s.suit,me(s)&&t.params[1]){let f=g.toSuit(t.params[1]),_=f<2?a.red(p[f]):a.black(p[f]),he=a.bgWhite(_);console.log(`O ${e} pediu para trocar para o naipe ${he}.`),W=f}s.value===m.Jack?b=2:s.value===m.Joker?b=4:s.value===m.Queen?n.flow===y.FORWARD?(console.log("Mudando o fluxo para o sentido contr\xE1rio."),n.flow=y.BACKWARD):(console.log("Mudando o fluxo para o sentido normal."),n.flow=y.FORWARD):s.value===m.King&&(console.log("Pr\xF3ximo jogador pula a vez."),n.nextPlayer());break;case"BUY":let c=parseInt(t.params[0]);if(b>0&&b!==c){console.log(`O ${e} deveria comprar ${b} cartas, mas tentou comprar ${c}.`),console.log(`N\xE3o d\xE1 mais para sincronizar as a\xE7\xF5es e ${e} \xE9 eliminado.`),n.quit(r),b=0;break}for(let f=0;f<c;f++){N.length===0&&n.over("Acabaram as cartas de puxar.");let _=N.pop();e.cards.push(_),await n.send(r,_.str)}console.log(`O ${e} comprou ${c} carta${c>1?"s":""}.`),b=0,(w.value===m.Jack||w.value===m.Joker)&&(w=new g(m.Ace,w.suit));break}}catch(r){console.log(r)}}function Be(){console.log("COLOCA\xC7\xC3O"),P.bots.sort((r,e)=>r.cards.length-e.cards.length).forEach((r,e)=>console.log(`${e+1}\xBA: ${r.id} - ${r.cards.length} cartas`))}
